<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TC SignLab Admin</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, sans-serif; background: #f5f5f5; }
        .header { background: #1D3557; color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 1.5rem; }
        .logout { background: #E63946; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
        .container { max-width: 1400px; margin: 30px auto; padding: 0 20px; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 15px; border-radius: 8px; flex-wrap: wrap; }
        .tab { padding: 10px 20px; background: #f0f0f0; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; }
        .tab.active { background: #0066cc; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .card { background: white; padding: 25px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 5px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem; }
        .btn { padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; }
        .btn-primary { background: #0066cc; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-warning { background: #ffc107; color: #000; }
        .product-list { margin-top: 20px; }
        .product-card { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #dee2e6; }
        .product-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px; }
        .product-title { font-size: 1.2rem; font-weight: 700; color: #1D3557; }
        .product-actions { display: flex; gap: 10px; flex-wrap: wrap; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .finish-option { background: white; border: 2px solid #0066cc; padding: 12px; border-radius: 5px; margin-bottom: 10px; }
        .finish-header { display: flex; justify-content: space-between; align-items: center; }
        .badge { display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 0.85rem; font-weight: 600; }
        .badge-category { background: #1D3557; color: white; }
        .badge-price { background: #E63946; color: white; margin-left: 8px; }
        .image-preview { margin-top: 10px; max-width: 300px; }
        .image-preview img { width: 100%; border-radius: 5px; }
        .alert { padding: 15px; border-radius: 5px; margin-bottom: 15px; }
        .alert-success { background: #d4edda; color: #155724; }
        .alert-error { background: #f8d7da; color: #721c24; }
        #productForm { display: none; }
        .option-item { background: #f8f9fa; padding: 10px; border-radius: 5px; margin-bottom: 8px; border-left: 4px solid #0066cc; }
        .option-header { display: flex; justify-content: space-between; align-items: center; }
        .category-card { background: white; border: 2px solid #0066cc; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .category-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üè¢ TC SignLab - Admin Panel</h1>
        <button class="logout" onclick="logout()">Logout</button>
    </div>

    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="openTab('products')">Products</button>
            <button class="tab" onclick="openTab('categories')">Product Categories</button>
            <button class="tab" onclick="openTab('finishing')">Finishing Options</button>
            <button class="tab" onclick="openTab('settings')">Settings</button>
        </div>

        <!-- PRODUCTS TAB -->
        <div id="productsTab" class="tab-content active">
            <div class="card">
                <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                    <h2>Manage Products</h2>
                    <button class="btn btn-primary" onclick="showAddProduct()">+ Add Product</button>
                </div>

                <div id="alertBox"></div>

                <!-- ADD/EDIT PRODUCT FORM -->
                <div id="productForm">
                    <h3 id="formTitle">Add New Product</h3>
                    <form onsubmit="saveProduct(event)">
                        <div class="form-group">
                            <label>Product Name *</label>
                            <input type="text" id="pName" required>
                        </div>

                        <div class="form-grid">
                            <div class="form-group">
                                <label>Category *</label>
                                <select id="pCategory" required>
                                    <option value="">Select Category</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Base Price ($/sq ft) *</label>
                                <input type="number" id="pPrice" step="0.01" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Description</label>
                            <textarea id="pDescription" rows="3"></textarea>
                        </div>

                        <div class="form-grid">
                            <div class="form-group">
                                <label>Max Width (inches) *</label>
                                <input type="number" id="pMaxWidth" value="200" required>
                            </div>
                            <div class="form-group">
                                <label>Max Height (inches) *</label>
                                <input type="number" id="pMaxHeight" value="150" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Image URL</label>
                            <input type="url" id="pImage" placeholder="https://example.com/image.jpg" onchange="previewImg()">
                            <div id="imgPreview" class="image-preview"></div>
                        </div>

                        <div class="form-group">
                            <label>Status</label>
                            <select id="pActive">
                                <option value="true">Active</option>
                                <option value="false">Inactive</option>
                            </select>
                        </div>

                        <!-- FINISHING OPTIONS -->
                        <div style="background:#fff3cd; padding:20px; border-radius:8px; margin:20px 0;">
                            <h4 style="margin-bottom:15px;">Select Finishing Options * (Select as many as needed)</h4>
                            
                            <div class="form-grid" style="margin-bottom:15px;">
                                <div class="form-group">
                                    <label>Category</label>
                                    <select id="fCategory" onchange="loadFinishOptions()">
                                        <option value="">Select Category</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Option</label>
                                    <select id="fOption" disabled>
                                        <option value="">Choose category first</option>
                                    </select>
                                </div>
                            </div>
                            
                            <button type="button" class="btn btn-success" onclick="addFinishOption()" style="width:100%;">
                                ‚ûï Add This Finishing Option
                            </button>

                            <div id="finishList" style="margin-top:15px;"></div>
                        </div>

                        <div style="display:flex; gap:10px;">
                            <button type="submit" class="btn btn-primary" style="flex:1;">Save Product</button>
                            <button type="button" class="btn btn-secondary" onclick="cancelForm()" style="flex:1;">Cancel</button>
                        </div>
                    </form>
                </div>

                <!-- PRODUCTS LIST -->
                <div id="productsList" class="product-list"></div>
            </div>
        </div>

        <!-- CATEGORIES TAB -->
        <div id="categoriesTab" class="tab-content">
            <div class="card">
                <h2>Manage Product Categories</h2>
                <form onsubmit="saveCategory(event)" style="margin:20px 0;">
                    <div class="form-group">
                        <label>Category Name</label>
                        <input type="text" id="catName" required>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" id="catDesc">
                    </div>
                    <button type="submit" class="btn btn-primary">Add Category</button>
                </form>
                <div id="categoriesList"></div>
            </div>
        </div>

        <!-- FINISHING OPTIONS TAB -->
        <div id="finishingTab" class="tab-content">
            <div class="card">
                <h2>Manage Finishing Options</h2>
                <p style="color:#666; margin-bottom:20px;">Create categories and options that customers can choose from</p>
                
                <!-- Add New Category -->
                <div style="background:#e7f3ff; padding:20px; border-radius:8px; margin-bottom:30px;">
                    <h3 style="margin-bottom:15px;">Add New Finishing Category</h3>
                    <form onsubmit="saveFinishCategory(event)">
                        <div class="form-group">
                            <label>Category Name (e.g., "Edges", "Mounting")</label>
                            <input type="text" id="finishCatName" required>
                        </div>
                        <button type="submit" class="btn btn-success">Create Category</button>
                    </form>
                </div>

                <!-- Existing Categories with Options -->
                <div id="finishCategoriesList"></div>
            </div>
        </div>

        <!-- SETTINGS TAB -->
        <div id="settingsTab" class="tab-content">
            <div class="card">
                <h2>Business Settings</h2>
                <form onsubmit="saveSettings(event)">
                    <div class="form-group">
                        <label>Business Name</label>
                        <input type="text" id="bizName" value="TC SignLab">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="bizEmail" value="tcsignlab@gmail.com">
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" id="bizPhone" value="866-419-7446">
                    </div>
                    <button type="submit" class="btn btn-primary">Save Settings</button>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, push, set, update, remove, onValue } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // Password check
        if (!sessionStorage.getItem('adminAuth')) {
            window.location.href = './admin-login.html';
        }

        const app = initializeApp({
            apiKey: "AIzaSyAlrfBLg-yJtUzYYJKGfGICS_PQuGE8caY",
            authDomain: "tcsignlab-admin.firebaseapp.com",
            databaseURL: "https://tcsignlab-admin-default-rtdb.firebaseio.com",
            projectId: "tcsignlab-admin",
            storageBucket: "tcsignlab-admin.firebasestorage.app",
            messagingSenderId: "382892123645",
            appId: "1:382892123645:web:cf45e472749c66165d6594"
        });

        const db = getDatabase(app);
        
        let categories = {};
        let products = {};
        let finishCategories = {};
        let editingId = null;
        let selectedFinishing = [];

        // Initialize default finishing categories if not exist
        const initDefaults = async () => {
            const snap = await new Promise(resolve => {
                onValue(ref(db, 'finishingCategories'), s => resolve(s), {onlyOnce: true});
            });
            
            if (!snap.val()) {
                const defaults = {
                    'Edges': {
                        name: 'Edges',
                        options: {
                            'opt1': {name: 'Hems & Grommets', price: 15, description: 'Hemmed edges with grommets'},
                            'opt2': {name: 'Heat Sealed', price: 12, description: 'Clean sealed edges'},
                            'opt3': {name: 'Sewn Edges', price: 10, description: 'Double-stitched edges'},
                            'opt4': {name: 'Raw Cut', price: 0, description: 'Unfinished edges'}
                        }
                    },
                    'Mounting': {
                        name: 'Mounting',
                        options: {
                            'opt1': {name: 'Pole Pockets', price: 20, description: 'Top/bottom pockets'},
                            'opt2': {name: 'Grommets Only', price: 8, description: 'Metal grommets'},
                            'opt3': {name: 'Velcro Strips', price: 25, description: 'Industrial velcro'},
                            'opt4': {name: 'No Hardware', price: 0, description: 'None included'}
                        }
                    },
                    'Reinforcement': {
                        name: 'Reinforcement',
                        options: {
                            'opt1': {name: 'Wind Slits', price: 10, description: 'Wind resistant'},
                            'opt2': {name: 'Corner Reinforcement', price: 15, description: 'Extra corners'},
                            'opt3': {name: 'Rope & Grommets', price: 18, description: 'Includes rope'},
                            'opt4': {name: 'Standard', price: 0, description: 'No extra'}
                        }
                    },
                    'Special': {
                        name: 'Special',
                        options: {
                            'opt1': {name: 'Custom Size', price: 30, description: 'Precise cutting'},
                            'opt2': {name: 'Rush Production', price: 50, description: '24hr turnaround'},
                            'opt3': {name: 'Weather Coating', price: 35, description: 'UV protection'},
                            'opt4': {name: 'None', price: 0, description: 'No special'}
                        }
                    }
                };
                await set(ref(db, 'finishingCategories'), defaults);
            }
        };

        initDefaults();

        // Load categories
        onValue(ref(db, 'categories'), (snap) => {
            categories = snap.val() || {};
            updateCategorySelect();
            displayCategories();
        });

        // Load products
        onValue(ref(db, 'products'), (snap) => {
            products = snap.val() || {};
            displayProducts();
        });

        // Load finishing categories
        onValue(ref(db, 'finishingCategories'), (snap) => {
            finishCategories = snap.val() || {};
            updateFinishCategorySelect();
            displayFinishCategories();
        });

        function updateCategorySelect() {
            const sel = document.getElementById('pCategory');
            sel.innerHTML = '<option value="">Select Category</option>' +
                Object.entries(categories).map(([id, c]) => 
                    `<option value="${id}">${c.name}</option>`
                ).join('');
        }

        function updateFinishCategorySelect() {
            const sel = document.getElementById('fCategory');
            sel.innerHTML = '<option value="">Select Category</option>' +
                Object.entries(finishCategories).map(([id, c]) => 
                    `<option value="${id}">${c.name}</option>`
                ).join('');
        }

        function displayProducts() {
            const list = document.getElementById('productsList');
            const pArray = Object.entries(products).map(([id, p]) => ({id, ...p}));
            
            if (pArray.length === 0) {
                list.innerHTML = '<p style="text-align:center; color:#999; padding:40px;">No products yet. Click "Add Product" to create one.</p>';
                return;
            }

            list.innerHTML = pArray.map(p => `
                <div class="product-card">
                    <div class="product-header">
                        <div style="flex:1;">
                            <div class="product-title">${p.name}</div>
                            <p style="color:#666; margin:5px 0;">${p.description || ''}</p>
                            <div style="margin:10px 0;">
                                <strong>$${p.basePrice}/sq ft</strong> ‚Ä¢ 
                                ${categories[p.category]?.name || 'N/A'} ‚Ä¢ 
                                ${p.maxWidth}"W x ${p.maxHeight}"H ‚Ä¢ 
                                ${p.active ? '‚úì Active' : '‚úó Inactive'}
                            </div>
                            ${p.imageUrl ? `<img src="${p.imageUrl}" style="max-width:150px; border-radius:5px; margin:10px 0;">` : ''}
                            ${p.finishingOptions?.length ? `
                                <div style="background:#f0f0f0; padding:10px; border-radius:5px; margin-top:10px;">
                                    <strong>Finishing Options (${p.finishingOptions.length}):</strong>
                                    ${p.finishingOptions.map(f => `
                                        <div style="margin:5px 0;">
                                            <span class="badge badge-category">${f.category}</span>
                                            ${f.name}
                                            <span class="badge badge-price">+$${f.price}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : '<p style="color:#dc3545;">‚ö†Ô∏è No finishing options</p>'}
                        </div>
                        <div class="product-actions">
                            <button class="btn btn-primary" onclick="editProduct('${p.id}')">Edit</button>
                            <button class="btn btn-danger" onclick="deleteProduct('${p.id}')">Delete</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function displayCategories() {
            const list = document.getElementById('categoriesList');
            const cArray = Object.entries(categories).map(([id, c]) => ({id, ...c}));
            
            list.innerHTML = cArray.map(c => `
                <div class="product-card">
                    <div class="product-header">
                        <div>
                            <strong>${c.name}</strong>
                            <p style="color:#666;">${c.description || ''}</p>
                        </div>
                        <button class="btn btn-danger" onclick="deleteCategory('${c.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function displayFinishCategories() {
            const list = document.getElementById('finishCategoriesList');
            const cArray = Object.entries(finishCategories).map(([id, c]) => ({id, ...c}));
            
            if (cArray.length === 0) {
                list.innerHTML = '<p style="text-align:center; color:#999; padding:20px;">No finishing categories yet.</p>';
                return;
            }

            list.innerHTML = cArray.map(cat => `
                <div class="category-card">
                    <div class="category-header">
                        <h3>${cat.name}</h3>
                        <button class="btn btn-danger" onclick="deleteFinishCategory('${cat.id}')">Delete Category</button>
                    </div>

                    <!-- Add Option to Category -->
                    <form onsubmit="addOptionToCategory(event, '${cat.id}')" style="background:#f8f9fa; padding:15px; border-radius:5px; margin-bottom:15px;">
                        <h4 style="margin-bottom:10px;">Add Option to ${cat.name}</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Option Name</label>
                                <input type="text" id="optName_${cat.id}" required>
                            </div>
                            <div class="form-group">
                                <label>Price ($)</label>
                                <input type="number" id="optPrice_${cat.id}" step="0.01" value="0" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <input type="text" id="optDesc_${cat.id}" required>
                        </div>
                        <button type="submit" class="btn btn-success">Add Option</button>
                    </form>

                    <!-- Options List -->
                    <div>
                        <strong>Options in this category:</strong>
                        ${Object.entries(cat.options || {}).map(([optId, opt]) => `
                            <div class="option-item">
                                <div class="option-header">
                                    <div>
                                        <strong>${opt.name}</strong>
                                        <span class="badge badge-price">$${opt.price}</span>
                                        <div style="color:#666; font-size:0.9rem; margin-top:5px;">${opt.description || ''}</div>
                                    </div>
                                    <button class="btn btn-danger" onclick="deleteFinishOption('${cat.id}', '${optId}')" style="padding:6px 12px;">Delete</button>
                                </div>
                            </div>
                        `).join('') || '<p style="color:#999; margin:10px 0;">No options yet</p>'}
                    </div>
                </div>
            `).join('');
        }

        window.openTab = function(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');
        };

        window.showAddProduct = function() {
            document.getElementById('productForm').style.display = 'block';
            document.getElementById('formTitle').textContent = 'Add New Product';
            editingId = null;
            selectedFinishing = [];
            updateFinishList();
            document.getElementById('productForm').scrollIntoView({behavior: 'smooth'});
        };

        window.cancelForm = function() {
            document.getElementById('productForm').style.display = 'none';
            document.querySelector('#productForm form').reset();
            editingId = null;
            selectedFinishing = [];
            updateFinishList();
            document.getElementById('imgPreview').innerHTML = '';
        };

        window.previewImg = function() {
            const url = document.getElementById('pImage').value;
            const preview = document.getElementById('imgPreview');
            if (url) {
                preview.innerHTML = `<img src="${url}" onerror="this.src=''; this.alt='Failed to load';">`;
            } else {
                preview.innerHTML = '';
            }
        };

        window.loadFinishOptions = function() {
            const catId = document.getElementById('fCategory').value;
            const sel = document.getElementById('fOption');
            
            if (!catId) {
                sel.disabled = true;
                sel.innerHTML = '<option value="">Choose category first</option>';
                return;
            }

            const cat = finishCategories[catId];
            const options = cat?.options || {};

            sel.disabled = false;
            sel.innerHTML = '<option value="">Select option</option>' +
                Object.entries(options).map(([optId, opt]) => 
                    `<option value="${optId}">${opt.name} (+$${opt.price})</option>`
                ).join('');
        };

        window.addFinishOption = function() {
            const catId = document.getElementById('fCategory').value;
            const optId = document.getElementById('fOption').value;

            if (!catId || !optId) {
                alert('Please select category and option');
                return;
            }

            const cat = finishCategories[catId];
            const opt = cat.options[optId];

            // Check if already added
            const exists = selectedFinishing.find(f => f.categoryId === catId && f.optionId === optId);
            if (exists) {
                alert('This option is already added');
                return;
            }

            selectedFinishing.push({
                categoryId: catId,
                optionId: optId,
                category: cat.name,
                name: opt.name,
                price: opt.price,
                description: opt.description
            });

            updateFinishList();
            document.getElementById('fCategory').value = '';
            document.getElementById('fOption').disabled = true;
            document.getElementById('fOption').innerHTML = '<option value="">Choose category first</option>';
        };

        window.removeFinish = function(idx) {
            selectedFinishing.splice(idx, 1);
            updateFinishList();
        };

        function updateFinishList() {
            const list = document.getElementById('finishList');
            
            if (selectedFinishing.length === 0) {
                list.innerHTML = '<p style="color:#999; text-align:center; margin-top:10px;">No options selected yet (you can add multiple)</p>';
                return;
            }

            list.innerHTML = `
                <div style="background:#d4edda; padding:10px; border-radius:5px; margin-bottom:10px;">
                    <strong style="color:#155724;">‚úì ${selectedFinishing.length} option(s) selected</strong>
                </div>
            ` + selectedFinishing.map((f, i) => `
                <div class="finish-option">
                    <div class="finish-header">
                        <div>
                            <span class="badge badge-category">${f.category}</span>
                            <span class="badge badge-price">+$${f.price}</span>
                            <div style="margin-top:5px;"><strong>${f.name}</strong></div>
                            <div style="color:#666; font-size:0.9rem;">${f.description}</div>
                        </div>
                        <button type="button" class="btn btn-danger" onclick="removeFinish(${i})">‚úï</button>
                    </div>
                </div>
            `).join('');
        }

        window.saveProduct = async function(e) {
            e.preventDefault();

            const name = document.getElementById('pName').value;
            const category = document.getElementById('pCategory').value;
            const price = document.getElementById('pPrice').value;

            if (!name || !category || !price) {
                alert('Please fill required fields');
                return;
            }

            if (selectedFinishing.length === 0) {
                alert('Please select at least one finishing option');
                return;
            }

            const product = {
                name,
                category,
                basePrice: parseFloat(price),
                description: document.getElementById('pDescription').value,
                maxWidth: parseInt(document.getElementById('pMaxWidth').value),
                maxHeight: parseInt(document.getElementById('pMaxHeight').value),
                imageUrl: document.getElementById('pImage').value,
                active: document.getElementById('pActive').value === 'true',
                finishingOptions: selectedFinishing,
                sortOrder: 0
            };

            try {
                if (editingId) {
                    await update(ref(db, `products/${editingId}`), product);
                    showAlert('Product updated!', 'success');
                } else {
                    await push(ref(db, 'products'), product);
                    showAlert('Product added!', 'success');
                }
                cancelForm();
            } catch (err) {
                showAlert('Error: ' + err.message, 'error');
            }
        };

        window.editProduct = function(id) {
            const p = products[id];
            editingId = id;

            document.getElementById('productForm').style.display = 'block';
            document.getElementById('formTitle').textContent = 'Edit Product';
            document.getElementById('pName').value = p.name;
            document.getElementById('pCategory').value = p.category;
            document.getElementById('pPrice').value = p.basePrice;
            document.getElementById('pDescription').value = p.description || '';
            document.getElementById('pMaxWidth').value = p.maxWidth;
            document.getElementById('pMaxHeight').value = p.maxHeight;
            document.getElementById('pImage').value = p.imageUrl || '';
            document.getElementById('pActive').value = p.active ? 'true' : 'false';
            
            selectedFinishing = p.finishingOptions || [];
            updateFinishList();
            previewImg();
            
            document.getElementById('productForm').scrollIntoView({behavior: 'smooth'});
        };

        window.deleteProduct = async function(id) {
            if (!confirm('Delete this product?')) return;
            try {
                await remove(ref(db, `products/${id}`));
                showAlert('Product deleted', 'success');
            } catch (err) {
                showAlert('Error: ' + err.message, 'error');
            }
        };

        window.saveCategory = async function(e) {
            e.preventDefault();
            const name = document.getElementById('catName').value;
            const desc = document.getElementById('catDesc').value;

            try {
                await push(ref(db, 'categories'), {name, description: desc, sortOrder: 0});
                showAlert('Category added!', 'success');
                e.target.reset();
            } catch (err) {
                showAlert('Error: ' + err.message, 'error');
            }
        };

        window.deleteCategory = async function(id) {
            if (!confirm('Delete this category?')) return;
            try {
                await remove(ref(db, `categories/${id}`));
                showAlert('Category deleted', 'success');
            } catch (err) {
                showAlert('Error: ' + err.message, 'error');
            }
        };

        // FINISHING OPTIONS MANAGEMENT
        window.saveFinishCategory = async function(e) {
            e.preventDefault();
            const name = document.getElementById('finishCatName').value;

            try {
                await push(ref(db, 'finishingCategories'), {
                    name,
                    options: {}
                });
                showAlert('Finishing category created!', 'success');
                e.target.reset();
            } catch (err) {
                showAlert('Error: ' + err.message, 'error');
            }
        };

        window.deleteFinishCategory = async function(catId) {
            if (!confirm('Delete this finishing category and all its options?')) return;
            try {
                await remove(ref(db, `finishingCategories/${catId}`));
                showAlert('Category deleted', 'success');
            } catch (err) {
                showAlert('Error: ' + err.message, 'error');
            }
        };

        window.addOptionToCategory = async function(e, catId) {
            e.preventDefault();
            
            const name = document.getElementById(`optName_${catId}`).value;
            const price = parseFloat(document.getElementById(`optPrice_${catId}`).value);
            const desc = document.getElementById(`optDesc_${catId}`).value;

            try {
                await push(ref(db, `finishingCategories/${catId}/options`), {
                    name,
                    price,
                    description: desc
                });
                showAlert('Option added!', 'success');
                e.target.reset();
            } catch (err) {
                showAlert('Error: ' + err.message, 'error');
            }
        };

        window.deleteFinishOption = async function(catId, optId) {
            if (!confirm('Delete this option?')) return;
            try {
                await remove(ref(db, `finishingCategories/${catId}/options/${optId}`));
                showAlert('Option deleted', 'success');
            } catch (err) {
                showAlert('Error: ' + err.message, 'error');
            }
        };

        window.saveSettings = async function(e) {
            e.preventDefault();
            const settings = {
                businessName: document.getElementById('bizName').value,
                email: document.getElementById('bizEmail').value,
                phone: document.getElementById('bizPhone').value
            };

            try {
                await set(ref(db, 'settings'), settings);
                showAlert('Settings saved!', 'success');
            } catch (err) {
                showAlert('Error: ' + err.message, 'error');
            }
        };

        window.logout = function() {
            if (confirm('Logout?')) {
                sessionStorage.removeItem('adminAuth');
                window.location.href = './admin-login.html';
            }
        };

        function showAlert(msg, type) {
            const box = document.getElementById('alertBox');
            box.className = `alert alert-${type}`;
            box.textContent = msg;
            box.style.display = 'block';
            setTimeout(() => box.style.display = 'none', 3000);
        }
    </script>
</body>
</html>
