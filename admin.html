<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>TC SignLab Admin</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; }
        .header { background: #1D3557; color: white; padding: 20px; }
        .container { max-width: 1200px; margin: 20px auto; padding: 20px; }
        .tabs { background: white; padding: 15px; margin-bottom: 20px; border-radius: 8px; }
        .tab { padding: 10px 20px; background: #eee; border: none; margin-right: 10px; cursor: pointer; border-radius: 5px; }
        .tab.active { background: #0066cc; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .card { background: white; padding: 25px; border-radius: 8px; margin-bottom: 20px; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-primary { background: #0066cc; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        input, select, textarea { width: 100%; padding: 8px; margin: 5px 0 15px 0; border: 1px solid #ddd; border-radius: 4px; }
        label { font-weight: bold; display: block; margin-top: 10px; }
        .product-item { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 5px; border: 2px solid #dee2e6; }
        .alert { padding: 15px; margin: 15px 0; border-radius: 5px; display: none; }
        .alert.success { background: #d4edda; color: #155724; }
        .alert.error { background: #f8d7da; color: #721c24; }
        .finish-item { background: white; padding: 10px; margin: 5px 0; border: 2px solid #0066cc; border-radius: 5px; }
        #productForm { display: none; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>TC SignLab Admin Panel</h1>
    </div>

    <div class="container">
        <div class="tabs">
            <button class="tab active" data-tab="products">Products</button>
            <button class="tab" data-tab="categories">Categories</button>
            <button class="tab" data-tab="finishing">Finishing Options</button>
        </div>

        <div id="productsTab" class="tab-content active">
            <div class="card">
                <h2>Products</h2>
                <button class="btn btn-primary" id="showProductForm">+ Add Product</button>
                
                <div id="alertBox" class="alert"></div>

                <div id="productForm" class="card" style="background: #f8f9fa;">
                    <h3 id="formTitle">Add Product</h3>
                    <form id="productFormElement">
                        <label>Product Name *</label>
                        <input type="text" id="productName" required>

                        <label>Category *</label>
                        <select id="productCategory" required></select>

                        <label>Base Price ($/sq ft) *</label>
                        <input type="number" id="productPrice" step="0.01" required>

                        <label>Description</label>
                        <textarea id="productDescription" rows="3"></textarea>

                        <label>Max Width (inches) *</label>
                        <input type="number" id="productMaxWidth" value="200" required>

                        <label>Max Height (inches) *</label>
                        <input type="number" id="productMaxHeight" value="150" required>

                        <label>Image URL</label>
                        <input type="url" id="productImageUrl">

                        <label>Status</label>
                        <select id="productActive">
                            <option value="true">Active</option>
                            <option value="false">Inactive</option>
                        </select>

                        <div style="background: #fff3cd; padding: 15px; margin: 20px 0; border-radius: 5px;">
                            <h4>Finishing Options *</h4>
                            <label>Category</label>
                            <select id="finishCategory"></select>
                            
                            <label>Option</label>
                            <select id="finishOption"></select>
                            
                            <button type="button" class="btn btn-success" id="addFinishBtn">Add Finishing Option</button>
                            
                            <div id="selectedFinishing" style="margin-top: 15px;"></div>
                        </div>

                        <button type="submit" class="btn btn-primary">Save Product</button>
                        <button type="button" class="btn" id="cancelBtn" style="background: #6c757d; color: white;">Cancel</button>
                    </form>
                </div>

                <div id="productsList"></div>
            </div>
        </div>

        <div id="categoriesTab" class="tab-content">
            <div class="card">
                <h2>Product Categories</h2>
                <input type="text" id="newCategoryName" placeholder="Category name">
                <input type="text" id="newCategoryDesc" placeholder="Description">
                <button class="btn btn-primary" id="addCategoryBtn">Add Category</button>
                <div id="categoriesList"></div>
            </div>
        </div>

        <div id="finishingTab" class="tab-content">
            <div class="card">
                <h2>Finishing Options</h2>
                <input type="text" id="newFinishCatName" placeholder="New category name (e.g., Edges)">
                <button class="btn btn-success" id="addFinishCatBtn">Create Category</button>
                <div id="finishingCategoriesList"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, push, set, update, remove, onValue } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const app = initializeApp({
            apiKey: "AIzaSyAlrfBLg-yJtUzYYJKGfGICS_PQuGE8caY",
            authDomain: "tcsignlab-admin.firebaseapp.com",
            databaseURL: "https://tcsignlab-admin-default-rtdb.firebaseio.com",
            projectId: "tcsignlab-admin",
            storageBucket: "tcsignlab-admin.firebasestorage.app",
            messagingSenderId: "382892123645",
            appId: "1:382892123645:web:cf45e472749c66165d6594"
        });

        const db = getDatabase(app);
        
        let categories = {};
        let products = {};
        let finishingCategories = {};
        let editingProductId = null;
        let selectedFinishing = [];

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const target = this.dataset.tab;
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                this.classList.add('active');
                document.getElementById(target + 'Tab').classList.add('active');
            });
        });

        // Show product form
        document.getElementById('showProductForm').addEventListener('click', () => {
            document.getElementById('productForm').style.display = 'block';
            document.getElementById('formTitle').textContent = 'Add Product';
            document.getElementById('productFormElement').reset();
            editingProductId = null;
            selectedFinishing = [];
            updateSelectedFinishing();
        });

        // Cancel form
        document.getElementById('cancelBtn').addEventListener('click', () => {
            document.getElementById('productForm').style.display = 'none';
            document.getElementById('productFormElement').reset();
            editingProductId = null;
            selectedFinishing = [];
        });

        // Load categories
        onValue(ref(db, 'categories'), (snapshot) => {
            categories = snapshot.val() || {};
            const select = document.getElementById('productCategory');
            select.innerHTML = '<option value="">Select Category</option>' +
                Object.entries(categories).map(([id, cat]) => 
                    `<option value="${id}">${cat.name}</option>`
                ).join('');
            displayCategories();
        });

        // Load products
        onValue(ref(db, 'products'), (snapshot) => {
            products = snapshot.val() || {};
            displayProducts();
        });

        // Load finishing categories
        onValue(ref(db, 'finishingCategories'), (snapshot) => {
            finishingCategories = snapshot.val() || {};
            const select = document.getElementById('finishCategory');
            select.innerHTML = '<option value="">Select Category</option>' +
                Object.entries(finishingCategories).map(([id, cat]) => 
                    `<option value="${id}">${cat.name}</option>`
                ).join('');
            displayFinishingCategories();
        });

        // When finish category changes, load options
        document.getElementById('finishCategory').addEventListener('change', function() {
            const catId = this.value;
            const optSelect = document.getElementById('finishOption');
            
            if (!catId) {
                optSelect.innerHTML = '<option value="">Select category first</option>';
                return;
            }

            const cat = finishingCategories[catId];
            const options = cat?.options || {};
            
            optSelect.innerHTML = '<option value="">Select Option</option>' +
                Object.entries(options).map(([optId, opt]) => 
                    `<option value="${optId}">${opt.name} (+$${opt.price})</option>`
                ).join('');
        });

        // Add finishing option to product
        document.getElementById('addFinishBtn').addEventListener('click', () => {
            const catId = document.getElementById('finishCategory').value;
            const optId = document.getElementById('finishOption').value;

            if (!catId || !optId) {
                alert('Please select both category and option');
                return;
            }

            const cat = finishingCategories[catId];
            const opt = cat.options[optId];

            // Check if already added
            const exists = selectedFinishing.find(f => f.categoryId === catId && f.optionId === optId);
            if (exists) {
                alert('Already added');
                return;
            }

            selectedFinishing.push({
                categoryId: catId,
                optionId: optId,
                category: cat.name,
                name: opt.name,
                price: opt.price,
                description: opt.description
            });

            updateSelectedFinishing();
            document.getElementById('finishCategory').value = '';
            document.getElementById('finishOption').innerHTML = '<option value="">Select category first</option>';
        });

        function updateSelectedFinishing() {
            const container = document.getElementById('selectedFinishing');
            
            if (selectedFinishing.length === 0) {
                container.innerHTML = '<p style="color: #999;">No options selected yet</p>';
                return;
            }

            container.innerHTML = `<strong>${selectedFinishing.length} option(s) selected:</strong>` +
                selectedFinishing.map((f, i) => `
                    <div class="finish-item">
                        <strong>${f.category}: ${f.name}</strong> (+$${f.price})
                        <button type="button" onclick="removeFinish(${i})" class="btn btn-danger" style="float: right; padding: 5px 10px;">Remove</button>
                        <div style="clear: both;"></div>
                        <small>${f.description}</small>
                    </div>
                `).join('');
        }

        window.removeFinish = function(index) {
            selectedFinishing.splice(index, 1);
            updateSelectedFinishing();
        };

        // Save product
        document.getElementById('productFormElement').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (selectedFinishing.length === 0) {
                alert('Please add at least one finishing option');
                return;
            }

            const product = {
                name: document.getElementById('productName').value,
                category: document.getElementById('productCategory').value,
                basePrice: parseFloat(document.getElementById('productPrice').value),
                description: document.getElementById('productDescription').value,
                maxWidth: parseInt(document.getElementById('productMaxWidth').value),
                maxHeight: parseInt(document.getElementById('productMaxHeight').value),
                imageUrl: document.getElementById('productImageUrl').value,
                active: document.getElementById('productActive').value === 'true',
                finishingOptions: selectedFinishing
            };

            try {
                if (editingProductId) {
                    await update(ref(db, `products/${editingProductId}`), product);
                    showAlert('Product updated!', 'success');
                } else {
                    await push(ref(db, 'products'), product);
                    showAlert('Product added!', 'success');
                }
                document.getElementById('productForm').style.display = 'none';
                document.getElementById('productFormElement').reset();
                editingProductId = null;
                selectedFinishing = [];
            } catch (err) {
                showAlert('Error: ' + err.message, 'error');
            }
        });

        function displayProducts() {
            const list = document.getElementById('productsList');
            const items = Object.entries(products).map(([id, p]) => ({id, ...p}));
            
            if (items.length === 0) {
                list.innerHTML = '<p style="padding: 40px; text-align: center; color: #999;">No products yet</p>';
                return;
            }

            list.innerHTML = items.map(p => `
                <div class="product-item">
                    <h3>${p.name}</h3>
                    <p>${p.description || ''}</p>
                    <p><strong>Price:</strong> $${p.basePrice}/sq ft | <strong>Max:</strong> ${p.maxWidth}"W x ${p.maxHeight}"H</p>
                    <p><strong>Category:</strong> ${categories[p.category]?.name || 'N/A'}</p>
                    ${p.finishingOptions?.length ? `
                        <p><strong>Finishing (${p.finishingOptions.length}):</strong></p>
                        <ul>
                            ${p.finishingOptions.map(f => `<li>${f.category}: ${f.name} (+$${f.price})</li>`).join('')}
                        </ul>
                    ` : '<p style="color: red;">⚠️ No finishing options</p>'}
                    <button onclick="editProduct('${p.id}')" class="btn btn-primary">Edit</button>
                    <button onclick="deleteProduct('${p.id}')" class="btn btn-danger">Delete</button>
                </div>
            `).join('');
        }

        window.editProduct = function(id) {
            const p = products[id];
            editingProductId = id;
            
            document.getElementById('productForm').style.display = 'block';
            document.getElementById('formTitle').textContent = 'Edit Product';
            document.getElementById('productName').value = p.name;
            document.getElementById('productCategory').value = p.category;
            document.getElementById('productPrice').value = p.basePrice;
            document.getElementById('productDescription').value = p.description || '';
            document.getElementById('productMaxWidth').value = p.maxWidth;
            document.getElementById('productMaxHeight').value = p.maxHeight;
            document.getElementById('productImageUrl').value = p.imageUrl || '';
            document.getElementById('productActive').value = p.active ? 'true' : 'false';
            
            selectedFinishing = p.finishingOptions || [];
            updateSelectedFinishing();
            
            window.scrollTo(0, 0);
        };

        window.deleteProduct = async function(id) {
            if (!confirm('Delete this product?')) return;
            await remove(ref(db, `products/${id}`));
            showAlert('Product deleted', 'success');
        };

        function displayCategories() {
            const list = document.getElementById('categoriesList');
            const items = Object.entries(categories).map(([id, c]) => ({id, ...c}));
            
            list.innerHTML = items.map(c => `
                <div class="product-item">
                    <strong>${c.name}</strong> - ${c.description || ''}
                    <button onclick="deleteCategory('${c.id}')" class="btn btn-danger" style="float: right;">Delete</button>
                </div>
            `).join('');
        }

        document.getElementById('addCategoryBtn').addEventListener('click', async () => {
            const name = document.getElementById('newCategoryName').value;
            const desc = document.getElementById('newCategoryDesc').value;
            
            if (!name) {
                alert('Please enter category name');
                return;
            }

            await push(ref(db, 'categories'), {name, description: desc});
            document.getElementById('newCategoryName').value = '';
            document.getElementById('newCategoryDesc').value = '';
            showAlert('Category added!', 'success');
        });

        window.deleteCategory = async function(id) {
            if (!confirm('Delete?')) return;
            await remove(ref(db, `categories/${id}`));
        };

        function displayFinishingCategories() {
            const list = document.getElementById('finishingCategoriesList');
            const items = Object.entries(finishingCategories).map(([id, c]) => ({id, ...c}));
            
            list.innerHTML = items.map(cat => `
                <div class="product-item">
                    <h3>${cat.name}</h3>
                    <input type="text" id="optName_${cat.id}" placeholder="Option name">
                    <input type="number" id="optPrice_${cat.id}" placeholder="Price" value="0" step="0.01">
                    <input type="text" id="optDesc_${cat.id}" placeholder="Description">
                    <button onclick="addOption('${cat.id}')" class="btn btn-success">Add Option</button>
                    <button onclick="deleteFinishCategory('${cat.id}')" class="btn btn-danger">Delete Category</button>
                    
                    <div style="margin-top: 10px;">
                        ${Object.entries(cat.options || {}).map(([optId, opt]) => `
                            <div style="background: white; padding: 8px; margin: 5px 0; border-left: 4px solid #0066cc;">
                                <strong>${opt.name}</strong> - $${opt.price} - ${opt.description}
                                <button onclick="deleteOption('${cat.id}', '${optId}')" class="btn btn-danger" style="float: right; padding: 5px 10px;">Delete</button>
                            </div>
                        `).join('') || '<p style="color: #999;">No options yet</p>'}
                    </div>
                </div>
            `).join('');
        }

        document.getElementById('addFinishCatBtn').addEventListener('click', async () => {
            const name = document.getElementById('newFinishCatName').value;
            if (!name) {
                alert('Enter category name');
                return;
            }
            await push(ref(db, 'finishingCategories'), {name, options: {}});
            document.getElementById('newFinishCatName').value = '';
            showAlert('Category created!', 'success');
        });

        window.addOption = async function(catId) {
            const name = document.getElementById(`optName_${catId}`).value;
            const price = parseFloat(document.getElementById(`optPrice_${catId}`).value);
            const desc = document.getElementById(`optDesc_${catId}`).value;
            
            if (!name) {
                alert('Enter option name');
                return;
            }

            await push(ref(db, `finishingCategories/${catId}/options`), {name, price, description: desc});
            document.getElementById(`optName_${catId}`).value = '';
            document.getElementById(`optPrice_${catId}`).value = '0';
            document.getElementById(`optDesc_${catId}`).value = '';
            showAlert('Option added!', 'success');
        };

        window.deleteFinishCategory = async function(id) {
            if (!confirm('Delete category and all options?')) return;
            await remove(ref(db, `finishingCategories/${id}`));
        };

        window.deleteOption = async function(catId, optId) {
            if (!confirm('Delete?')) return;
            await remove(ref(db, `finishingCategories/${catId}/options/${optId}`));
        };

        function showAlert(msg, type) {
            const box = document.getElementById('alertBox');
            box.className = `alert ${type}`;
            box.textContent = msg;
            box.style.display = 'block';
            setTimeout(() => box.style.display = 'none', 3000);
        }

        console.log('Admin panel loaded successfully');
    </script>
</body>
</html>
