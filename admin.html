<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TC SignLab - Admin Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #E63946;
            --secondary: #1D3557;
            --success: #28A745;
            --warning: #FFC107;
            --danger: #DC3545;
            --light-bg: #F8F9FA;
            --border: #DEE2E6;
            --text: #212529;
            --text-light: #6C757D;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--light-bg);
            color: var(--text);
        }
        
        .header {
            background: white;
            border-bottom: 3px solid var(--primary);
            padding: 20px 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo img {
            height: 50px;
        }
        
        .logo h1 {
            font-size: 1.8rem;
            color: var(--secondary);
        }
        
        .sync-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
        }
        
        .sync-status.synced {
            background: #D4EDDA;
            color: #155724;
        }
        
        .sync-status.syncing {
            background: #FFF3CD;
            color: #856404;
        }
        
        .sync-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 30px;
        }
        
        .tabs {
            display: flex;
            gap: 5px;
            background: white;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 30px;
            overflow-x: auto;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .tab {
            padding: 12px 20px;
            border: none;
            background: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-light);
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        .tab:hover {
            background: var(--light-bg);
            color: var(--text);
        }
        
        .tab.active {
            background: var(--primary);
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }
        
        .card h2 {
            color: var(--secondary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .form-group label {
            font-weight: 600;
            color: var(--text);
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 6px;
            font-size: 1rem;
            font-family: inherit;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: #D62828;
            transform: translateY(-1px);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-secondary {
            background: var(--border);
            color: var(--text);
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-sm {
            padding: 8px 16px;
            font-size: 0.9rem;
        }
        
        .items-list {
            display: grid;
            gap: 15px;
        }
        
        .item {
            background: var(--light-bg);
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 20px;
            align-items: center;
        }
        
        .item-image {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            object-fit: cover;
            background: white;
            border: 2px solid var(--border);
        }
        
        .item-info h3 {
            color: var(--secondary);
            margin-bottom: 8px;
        }
        
        .item-details {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            font-size: 0.9rem;
            color: var(--text-light);
        }
        
        .item-actions {
            display: flex;
            gap: 10px;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .badge-active {
            background: #D4EDDA;
            color: #155724;
        }
        
        .badge-inactive {
            background: #F8D7DA;
            color: #721C24;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, var(--primary), #D62828);
            color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(230, 57, 70, 0.2);
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .stat-label {
            opacity: 0.9;
            font-size: 0.9rem;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: var(--light-bg);
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .status-label {
            font-weight: 600;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .status-dot.active {
            background: var(--success);
        }
        
        .status-dot.inactive {
            background: var(--danger);
        }
        
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .alert-success {
            background: #D4EDDA;
            color: #155724;
            border: 2px solid #C3E6CB;
        }
        
        .alert-info {
            background: #D1ECF1;
            color: #0C5460;
            border: 2px solid #BEE5EB;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: var(--success);
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .loading {
            text-align: center;
            padding: 60px 20px;
        }
        
        .spinner {
            border: 4px solid var(--light-bg);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .image-upload {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .image-upload:hover {
            border-color: var(--primary);
            background: var(--light-bg);
        }
        
        .image-upload input {
            display: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <img src="tcsignlab.png" alt="TC SignLab" onerror="this.style.display='none'">
                <h1>Admin Panel</h1>
            </div>
            <div class="sync-status synced" id="syncStatus">
                <span class="sync-indicator"></span>
                <span id="syncText">Synced</span>
            </div>
        </div>
    </div>
    
    <div id="loadingScreen" class="loading">
        <div class="spinner"></div>
        <h3>Connecting to Firebase...</h3>
    </div>
    
    <div id="mainContent" style="display: none;">
        <div class="container">
            <div class="alert alert-success">
                <span>‚òÅÔ∏è</span>
                <span><strong>Cloud Sync Active!</strong> All changes save automatically and sync across devices.</span>
            </div>
            
            <div class="tabs">
                <button class="tab active" onclick="switchTab('products')">üì¶ Products</button>
                <button class="tab" onclick="switchTab('categories')">üìÅ Categories</button>
                <button class="tab" onclick="switchTab('materials')">üé® Materials</button>
                <button class="tab" onclick="switchTab('sizes')">üìè Sizes</button>
                <button class="tab" onclick="switchTab('finishing')">‚úÇÔ∏è Finishing</button>
                <button class="tab" onclick="switchTab('shipping')">üöö Shipping</button>
                <button class="tab" onclick="switchTab('settings')">‚öôÔ∏è Settings</button>
                <button class="tab" onclick="switchTab('status')">üìä Status</button>
            </div>
            
            <!-- Products Tab -->
            <div id="productsTab" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalProducts">0</div>
                        <div class="stat-label">Total Products</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, var(--success), #20873a);">
                        <div class="stat-number" id="activeProducts">0</div>
                        <div class="stat-label">Active Products</div>
                    </div>
                </div>
                
                <div class="card">
                    <h2>üì¶ Add New Product</h2>
                    <form id="productForm" onsubmit="saveProduct(event)">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Product Name *</label>
                                <input type="text" id="productName" required>
                            </div>
                            <div class="form-group">
                                <label>Category *</label>
                                <select id="productCategory" required>
                                    <option value="">Select Category</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Base Price ($/sq ft) *</label>
                                <input type="number" id="productPrice" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label>Status</label>
                                <select id="productActive">
                                    <option value="true">Active</option>
                                    <option value="false">Inactive</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea id="productDescription" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Product Image</label>
                            <div class="image-upload" onclick="document.getElementById('productImage').click()">
                                <input type="file" id="productImage" accept="image/*" onchange="uploadToImgBB(event)">
                                <p>üì∑ Click to upload image or drag & drop</p>
                                <small>PNG, JPG up to 5MB</small>
                            </div>
                            <input type="hidden" id="productImageUrl">
                            <div id="imagePreview" style="margin-top: 15px;"></div>
                            <div id="uploadProgress" style="display: none; margin-top: 10px;">
                                <div style="background: #e9ecef; height: 8px; border-radius: 4px; overflow: hidden;">
                                    <div id="progressBar" style="background: var(--primary); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                                </div>
                                <div id="uploadStatus" style="margin-top: 5px; font-size: 0.9rem; font-weight: 600; color: var(--text-light);"></div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button type="submit" class="btn btn-primary" id="productSubmitBtn">Add Product</button>
                            <button type="button" class="btn btn-secondary" onclick="cancelEdit()">Cancel</button>
                        </div>
                    </form>
                </div>
                
                <div class="card">
                    <h2>üì¶ All Products</h2>
                    <div id="productsList" class="items-list">
                        <p style="text-align: center; color: var(--text-light); padding: 40px;">
                            No products yet. Add your first product above!
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Categories Tab -->
            <div id="categoriesTab" class="tab-content">
                <div class="card">
                    <h2>üìÅ Add Category</h2>
                    <form id="categoryForm" onsubmit="saveCategory(event)">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Category Name *</label>
                                <input type="text" id="categoryName" required>
                            </div>
                            <div class="form-group">
                                <label>Sort Order</label>
                                <input type="number" id="categorySortOrder" value="0">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea id="categoryDescription" rows="2"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Category</button>
                    </form>
                </div>
                
                <div class="card">
                    <h2>üìÅ All Categories</h2>
                    <div id="categoriesList" class="items-list"></div>
                </div>
            </div>
            
            <!-- Materials Tab -->
            <div id="materialsTab" class="tab-content">
                <div class="card">
                    <h2>üé® Add Material</h2>
                    <form id="materialForm" onsubmit="saveMaterial(event)">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Material Name *</label>
                                <input type="text" id="materialName" required>
                            </div>
                            <div class="form-group">
                                <label>Price Modifier *</label>
                                <input type="number" id="materialPrice" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label>Max Width (inches) *</label>
                                <input type="number" id="materialMaxWidth" required>
                            </div>
                            <div class="form-group">
                                <label>Max Height (inches) *</label>
                                <input type="number" id="materialMaxHeight" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea id="materialDescription" rows="2"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Material</button>
                    </form>
                </div>
                
                <div class="card">
                    <h2>üé® All Materials</h2>
                    <div id="materialsList" class="items-list"></div>
                </div>
            </div>
            
            <!-- Sizes Tab -->
            <div id="sizesTab" class="tab-content">
                <div class="card">
                    <h2>üìè Manage Sizes</h2>
                    <div class="alert alert-info">
                        <span>üí°</span>
                        <span>Enter sizes in inches (will auto-convert to feet display). Separate with commas.</span>
                    </div>
                    <form id="sizesForm" onsubmit="saveSizes(event)">
                        <div class="form-group">
                            <label>Height Options (inches) *</label>
                            <input type="text" id="sizeHeights" placeholder="12, 24, 36, 48, 60, 72, 96" required>
                            <small>Example: 12, 24, 36 (will display as 1', 2', 3')</small>
                        </div>
                        <div class="form-group">
                            <label>Width Options (inches) *</label>
                            <input type="text" id="sizeWidths" placeholder="24, 36, 48, 72, 96, 120, 144" required>
                            <small>Example: 24, 48, 72 (will display as 2', 4', 6')</small>
                        </div>
                        <button type="submit" class="btn btn-primary">Save Sizes</button>
                    </form>
                    
                    <div style="margin-top: 30px;">
                        <h3>Current Size Options:</h3>
                        <div style="margin-top: 15px;">
                            <strong>Heights:</strong>
                            <div id="currentHeights" style="margin: 10px 0;"></div>
                            <strong>Widths:</strong>
                            <div id="currentWidths" style="margin: 10px 0;"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Finishing Tab -->
            <div id="finishingTab" class="tab-content">
                <div class="card">
                    <h2>‚úÇÔ∏è Add Finishing Option</h2>
                    <form id="finishingForm" onsubmit="saveFinishing(event)">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Finishing Name *</label>
                                <input type="text" id="finishingName" required>
                            </div>
                            <div class="form-group">
                                <label>Price *</label>
                                <input type="number" id="finishingPrice" step="0.01" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea id="finishingDescription" rows="2"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Finishing Option</button>
                    </form>
                </div>
                
                <div class="card">
                    <h2>‚úÇÔ∏è All Finishing Options</h2>
                    <div id="finishingList" class="items-list"></div>
                </div>
            </div>
            
            <!-- Shipping Tab -->
            <div id="shippingTab" class="tab-content">
                <div class="card">
                    <h2>üöö Add Shipping Option</h2>
                    <form id="shippingForm" onsubmit="saveShipping(event)">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Shipping Method *</label>
                                <input type="text" id="shippingName" required placeholder="e.g., Standard Shipping">
                            </div>
                            <div class="form-group">
                                <label>Price *</label>
                                <input type="number" id="shippingPrice" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label>Availability *</label>
                                <select id="shippingAvailability">
                                    <option value="all">All Products</option>
                                    <option value="banners">Banners Only</option>
                                    <option value="signs">Signs Only</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea id="shippingDescription" rows="2" placeholder="e.g., 5-7 business days"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Shipping Option</button>
                    </form>
                </div>
                
                <div class="card">
                    <h2>üöö All Shipping Options</h2>
                    <div id="shippingList" class="items-list"></div>
                </div>
            </div>
            
            <!-- Settings Tab -->
            <div id="settingsTab" class="tab-content">
                <div class="card">
                    <h2>‚öôÔ∏è Business Settings</h2>
                    <form id="settingsForm" onsubmit="saveSettings(event)">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Business Name *</label>
                                <input type="text" id="settingsBusinessName" required>
                            </div>
                            <div class="form-group">
                                <label>Email Address *</label>
                                <input type="email" id="settingsBusinessEmail" required>
                            </div>
                            <div class="form-group">
                                <label>Phone Number *</label>
                                <input type="tel" id="settingsBusinessPhone" required>
                            </div>
                            <div class="form-group">
                                <label>Free Shipping Threshold ($)</label>
                                <input type="number" id="settingsFreeShipping" step="0.01">
                            </div>
                        </div>
                        
                        <h3 style="margin: 30px 0 15px 0;">Social Media Links</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Facebook URL</label>
                                <input type="url" id="settingsFacebook" placeholder="https://facebook.com/tcsignlab">
                            </div>
                            <div class="form-group">
                                <label>Instagram URL</label>
                                <input type="url" id="settingsInstagram" placeholder="https://instagram.com/tcsignlab">
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-success">Save Settings</button>
                    </form>
                </div>
                
                <div class="card">
                    <h2>üíæ Data Management</h2>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="exportData()">üì• Export All Data</button>
                        <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">
                            üì§ Import Data
                        </button>
                        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
                        <button class="btn btn-danger" onclick="resetData()">üîÑ Reset to Defaults</button>
                    </div>
                </div>
            </div>
            
            <!-- Status Tab -->
            <div id="statusTab" class="tab-content">
                <div class="card">
                    <h2>üìä System Status</h2>
                    <div id="statusList">
                        <div class="status-item">
                            <span class="status-label">üî• Firebase Connection</span>
                            <div class="status-indicator">
                                <span class="status-dot active"></span>
                                <span>Connected</span>
                            </div>
                        </div>
                        <div class="status-item">
                            <span class="status-label">üí≥ Square Integration</span>
                            <div class="status-indicator" id="squareStatus">
                                <span class="status-dot inactive"></span>
                                <span>Checking...</span>
                            </div>
                        </div>
                        <div class="status-item">
                            <span class="status-label">‚ö° Netlify Functions</span>
                            <div class="status-indicator" id="netlifyStatus">
                                <span class="status-dot inactive"></span>
                                <span>Checking...</span>
                            </div>
                        </div>
                        <div class="status-item">
                            <span class="status-label">üìß Email Service (FormSubmit)</span>
                            <div class="status-indicator">
                                <span class="status-dot active"></span>
                                <span>Active</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, onValue, push, remove, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAlrfBLg-yJtUzYYJKGfGICS_PQuGE8caY",
            authDomain: "tcsignlab-admin.firebaseapp.com",
            databaseURL: "https://tcsignlab-admin-default-rtdb.firebaseio.com",
            projectId: "tcsignlab-admin",
            storageBucket: "tcsignlab-admin.firebasestorage.app",
            messagingSenderId: "382892123645",
            appId: "1:382892123645:web:cf45e472749c66165d6594"
        };
        
        // ImgBB configuration
        const IMGBB_API_KEY = '4d1a8206331234797988c3fdda3ce088';
        
        let app, database;
        let currentEditId = null;
        
        try {
            app = initializeApp(firebaseConfig);
            database = getDatabase(app);
            
            console.log('‚úÖ Firebase initialized');
            updateSyncStatus('synced', 'Synced');
            
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            
            // Load all data
            loadCategories();
            loadProducts();
            loadMaterials();
            loadSizes();
            loadFinishing();
            loadShipping();
            loadSettings();
            checkSystemStatus();
            
        } catch (error) {
            console.error('‚ùå Firebase error:', error);
            updateSyncStatus('error', 'Connection Error');
        }
        
        function updateSyncStatus(status, text) {
            const statusEl = document.getElementById('syncStatus');
            const textEl = document.getElementById('syncText');
            statusEl.className = `sync-status ${status}`;
            textEl.textContent = text;
        }
        
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            if (type === 'error') {
                notification.style.background = 'var(--danger)';
            }
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }
        
        // Tab switching
        window.switchTab = function(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        };
        
        // ImgBB Upload Functions
        window.uploadToImgBB = async function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Show progress
            document.getElementById('uploadProgress').style.display = 'block';
            document.getElementById('uploadStatus').textContent = 'Uploading...';
            
            const formData = new FormData();
            formData.append('image', file);
            
            try {
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                
                if (data.success) {
                    // Success!
                    document.getElementById('productImageUrl').value = data.data.url;
                    document.getElementById('progressBar').style.width = '100%';
                    document.getElementById('uploadStatus').textContent = '‚úì Upload complete!';
                    document.getElementById('uploadStatus').style.color = '#28A745';
                    
                    // Show preview
                    document.getElementById('imagePreview').innerHTML = `
                        <img src="${data.data.url}" style="max-width:200px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.1);">
                        <button onclick="removeImage()" style="display:block; margin-top:10px; padding:8px 16px; background:#dc3545; color:white; border:none; border-radius:6px; cursor:pointer;">Remove Image</button>
                    `;
                    
                    setTimeout(() => {
                        document.getElementById('uploadProgress').style.display = 'none';
                    }, 2000);
                } else {
                    throw new Error('ImgBB upload failed');
                }
            } catch (error) {
                console.error('Upload error:', error);
                document.getElementById('uploadStatus').textContent = '‚úó Upload failed';
                document.getElementById('uploadStatus').style.color = '#dc3545';
                setTimeout(() => {
                    document.getElementById('uploadProgress').style.display = 'none';
                }, 2000);
            }
        };
        
        window.removeImage = function() {
            document.getElementById('productImageUrl').value = '';
            document.getElementById('imagePreview').innerHTML = '';
            document.getElementById('productImage').value = '';
        };
        
        // Category Functions
        async function loadCategories() {
            const categoriesRef = ref(database, 'categories');
            const snapshot = await get(categoriesRef);
            const categories = snapshot.val() || {};
            
            // Update category dropdown
            const select = document.getElementById('productCategory');
            select.innerHTML = '<option value="">Select Category</option>';
            Object.entries(categories).forEach(([id, cat]) => {
                select.innerHTML += `<option value="${id}">${cat.name}</option>`;
            });
            
            // Update categories list
            const list = document.getElementById('categoriesList');
            if (Object.keys(categories).length === 0) {
                list.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 40px;">No categories yet.</p>';
                return;
            }
            
            list.innerHTML = Object.entries(categories)
                .sort(([,a], [,b]) => a.sortOrder - b.sortOrder)
                .map(([id, cat]) => `
                    <div class="item">
                        <div class="item-info">
                            <h3>${cat.name}</h3>
                            <div class="item-details">
                                <span>Sort Order: ${cat.sortOrder}</span>
                                ${cat.description ? `<span>${cat.description}</span>` : ''}
                            </div>
                        </div>
                        <div class="item-actions">
                            <button class="btn btn-sm btn-secondary" onclick="editCategory('${id}')">Edit</button>
                            <button class="btn btn-sm btn-secondary" onclick="cloneCategory('${id}')">Clone</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteCategory('${id}')">Delete</button>
                        </div>
                    </div>
                `).join('');
        }
        
        window.saveCategory = async function(e) {
            e.preventDefault();
            updateSyncStatus('syncing', 'Syncing...');
            
            const category = {
                name: document.getElementById('categoryName').value,
                sortOrder: parseInt(document.getElementById('categorySortOrder').value) || 0,
                description: document.getElementById('categoryDescription').value,
                active: true
            };
            
            try {
                const categoriesRef = ref(database, 'categories');
                await push(categoriesRef, category);
                showNotification('Category added successfully!');
                e.target.reset();
                loadCategories();
                updateSyncStatus('synced', 'Synced');
            } catch (error) {
                console.error(error);
                showNotification('Error adding category', 'error');
                updateSyncStatus('error', 'Error');
            }
        };
        
        window.deleteCategory = async function(id) {
            if (!confirm('Delete this category?')) return;
            updateSyncStatus('syncing', 'Syncing...');
            
            try {
                await remove(ref(database, `categories/${id}`));
                showNotification('Category deleted');
                loadCategories();
                updateSyncStatus('synced', 'Synced');
            } catch (error) {
                console.error(error);
                showNotification('Error deleting category', 'error');
            }
        };
        
        window.cloneCategory = async function(id) {
            const snapshot = await get(ref(database, `categories/${id}`));
            const category = snapshot.val();
            category.name += ' (Copy)';
            
            try {
                await push(ref(database, 'categories'), category);
                showNotification('Category cloned!');
                loadCategories();
            } catch (error) {
                showNotification('Error cloning category', 'error');
            }
        };
        
        // Product Functions
        async function loadProducts() {
            const productsRef = ref(database, 'products');
            const snapshot = await get(productsRef);
            const products = snapshot.val() || {};
            
            // Update stats
            const total = Object.keys(products).length;
            const active = Object.values(products).filter(p => p.active).length;
            document.getElementById('totalProducts').textContent = total;
            document.getElementById('activeProducts').textContent = active;
            
            // Update product list
            const list = document.getElementById('productsList');
            if (total === 0) {
                list.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 40px;">No products yet. Add your first product above!</p>';
                return;
            }
            
            list.innerHTML = Object.entries(products)
                .sort(([,a], [,b]) => (b.sortOrder || 0) - (a.sortOrder || 0))
                .map(([id, product]) => `
                    <div class="item">
                        ${product.imageUrl ? `<img src="${product.imageUrl}" class="item-image" alt="${product.name}">` : '<div class="item-image">üì¶</div>'}
                        <div class="item-info">
                            <h3>${product.name}</h3>
                            <div class="item-details">
                                <span><strong>$${product.basePrice}/sq ft</strong></span>
                                <span>${product.category || 'Uncategorized'}</span>
                                <span class="badge ${product.active ? 'badge-active' : 'badge-inactive'}">${product.active ? 'Active' : 'Inactive'}</span>
                            </div>
                        </div>
                        <div class="item-actions">
                            <button class="btn btn-sm btn-secondary" onclick="editProduct('${id}')">Edit</button>
                            <button class="btn btn-sm btn-secondary" onclick="cloneProduct('${id}')">Clone</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteProduct('${id}')">Delete</button>
                        </div>
                    </div>
                `).join('');
        }
        
        window.saveProduct = async function(e) {
            e.preventDefault();
            updateSyncStatus('syncing', 'Syncing...');
            
            const product = {
                name: document.getElementById('productName').value,
                category: document.getElementById('productCategory').value,
                basePrice: parseFloat(document.getElementById('productPrice').value),
                description: document.getElementById('productDescription').value,
                active: document.getElementById('productActive').value === 'true',
                imageUrl: document.getElementById('productImageUrl').value || '',
                sortOrder: 0
            };
            
            try {
                if (currentEditId) {
                    await update(ref(database, `products/${currentEditId}`), product);
                    showNotification('Product updated!');
                    currentEditId = null;
                    document.getElementById('productSubmitBtn').textContent = 'Add Product';
                } else {
                    await push(ref(database, 'products'), product);
                    showNotification('Product added!');
                }
                e.target.reset();
                document.getElementById('productImageUrl').value = '';
                document.getElementById('imagePreview').innerHTML = '';
                loadProducts();
                updateSyncStatus('synced', 'Synced');
            } catch (error) {
                console.error(error);
                showNotification('Error saving product', 'error');
            }
        };
        
        window.editProduct = async function(id) {
            const snapshot = await get(ref(database, `products/${id}`));
            const product = snapshot.val();
            
            document.getElementById('productName').value = product.name;
            document.getElementById('productCategory').value = product.category;
            document.getElementById('productPrice').value = product.basePrice;
            document.getElementById('productDescription').value = product.description || '';
            document.getElementById('productActive').value = product.active ? 'true' : 'false';
            
            // Handle image for edit
            if (product.imageUrl) {
                document.getElementById('productImageUrl').value = product.imageUrl;
                document.getElementById('imagePreview').innerHTML = `
                    <img src="${product.imageUrl}" style="max-width:200px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.1);">
                    <button onclick="removeImage()" style="display:block; margin-top:10px; padding:8px 16px; background:#dc3545; color:white; border:none; border-radius:6px; cursor:pointer;">Remove Image</button>
                `;
            } else {
                document.getElementById('productImageUrl').value = '';
                document.getElementById('imagePreview').innerHTML = '';
            }
            
            currentEditId = id;
            document.getElementById('productSubmitBtn').textContent = 'Update Product';
            document.getElementById('productsTab').scrollIntoView({ behavior: 'smooth' });
        };
        
        window.cancelEdit = function() {
            document.getElementById('productForm').reset();
            document.getElementById('productImageUrl').value = '';
            document.getElementById('imagePreview').innerHTML = '';
            currentEditId = null;
            document.getElementById('productSubmitBtn').textContent = 'Add Product';
        };
        
        window.cloneProduct = async function(id) {
            const snapshot = await get(ref(database, `products/${id}`));
            const product = snapshot.val();
            product.name += ' (Copy)';
            
            try {
                await push(ref(database, 'products'), product);
                showNotification('Product cloned!');
                loadProducts();
            } catch (error) {
                showNotification('Error cloning product', 'error');
            }
        };
        
        window.deleteProduct = async function(id) {
            if (!confirm('Delete this product?')) return;
            
            try {
                await remove(ref(database, `products/${id}`));
                showNotification('Product deleted');
                loadProducts();
            } catch (error) {
                showNotification('Error deleting product', 'error');
            }
        };
        
        // Material Functions
        async function loadMaterials() {
            const materialsRef = ref(database, 'materials');
            const snapshot = await get(materialsRef);
            const materials = snapshot.val() || {};
            
            const list = document.getElementById('materialsList');
            if (Object.keys(materials).length === 0) {
                list.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 40px;">No materials yet.</p>';
                return;
            }
            
            list.innerHTML = Object.entries(materials).map(([id, mat]) => `
                <div class="item">
                    <div class="item-info">
                        <h3>${mat.name}</h3>
                        <div class="item-details">
                            <span><strong>+$${mat.priceModifier}</strong></span>
                            <span>Max: ${mat.maxWidth}"W x ${mat.maxHeight}"H</span>
                            ${mat.description ? `<span>${mat.description}</span>` : ''}
                        </div>
                    </div>
                    <div class="item-actions">
                        <button class="btn btn-sm btn-secondary" onclick="editMaterial('${id}')">Edit</button>
                        <button class="btn btn-sm btn-secondary" onclick="cloneMaterial('${id}')">Clone</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteMaterial('${id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }
        
        window.saveMaterial = async function(e) {
            e.preventDefault();
            updateSyncStatus('syncing', 'Syncing...');
            
            const material = {
                name: document.getElementById('materialName').value,
                priceModifier: parseFloat(document.getElementById('materialPrice').value),
                maxWidth: parseInt(document.getElementById('materialMaxWidth').value),
                maxHeight: parseInt(document.getElementById('materialMaxHeight').value),
                description: document.getElementById('materialDescription').value,
                active: true
            };
            
            try {
                await push(ref(database, 'materials'), material);
                showNotification('Material added!');
                e.target.reset();
                loadMaterials();
                updateSyncStatus('synced', 'Synced');
            } catch (error) {
                showNotification('Error adding material', 'error');
            }
        };
        
        window.deleteMaterial = async function(id) {
            if (!confirm('Delete this material?')) return;
            
            try {
                await remove(ref(database, `materials/${id}`));
                showNotification('Material deleted');
                loadMaterials();
            } catch (error) {
                showNotification('Error deleting material', 'error');
            }
        };
        
        window.cloneMaterial = async function(id) {
            const snapshot = await get(ref(database, `materials/${id}`));
            const material = snapshot.val();
            material.name += ' (Copy)';
            
            try {
                await push(ref(database, 'materials'), material);
                showNotification('Material cloned!');
                loadMaterials();
            } catch (error) {
                showNotification('Error cloning material', 'error');
            }
        };
        
        // Sizes Functions
        async function loadSizes() {
            const sizesRef = ref(database, 'sizes');
            const snapshot = await get(sizesRef);
            const sizes = snapshot.val() || { heights: [12, 24, 36, 48, 60, 72, 96], widths: [24, 36, 48, 72, 96, 120, 144] };
            
            document.getElementById('sizeHeights').value = sizes.heights.join(', ');
            document.getElementById('sizeWidths').value = sizes.widths.join(', ');
            
            displayCurrentSizes(sizes);
        }
        
        function displayCurrentSizes(sizes) {
            const heightsDiv = document.getElementById('currentHeights');
            const widthsDiv = document.getElementById('currentWidths');
            
            heightsDiv.innerHTML = sizes.heights.map(h => `<span class="badge badge-active" style="margin: 5px;">${h}" (${(h/12).toFixed(1)}')</span>`).join('');
            widthsDiv.innerHTML = sizes.widths.map(w => `<span class="badge badge-active" style="margin: 5px;">${w}" (${(w/12).toFixed(1)}')</span>`).join('');
        }
        
        window.saveSizes = async function(e) {
            e.preventDefault();
            updateSyncStatus('syncing', 'Syncing...');
            
            const heights = document.getElementById('sizeHeights').value.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n));
            const widths = document.getElementById('sizeWidths').value.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n));
            
            const sizes = { heights, widths };
            
            try {
                await set(ref(database, 'sizes'), sizes);
                showNotification('Sizes saved!');
                displayCurrentSizes(sizes);
                updateSyncStatus('synced', 'Synced');
            } catch (error) {
                showNotification('Error saving sizes', 'error');
            }
        };
        
        // Finishing Functions
        async function loadFinishing() {
            const finishingRef = ref(database, 'finishing');
            const snapshot = await get(finishingRef);
            const finishing = snapshot.val() || {};
            
            const list = document.getElementById('finishingList');
            if (Object.keys(finishing).length === 0) {
                list.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 40px;">No finishing options yet.</p>';
                return;
            }
            
            list.innerHTML = Object.entries(finishing).map(([id, fin]) => `
                <div class="item">
                    <div class="item-info">
                        <h3>${fin.name}</h3>
                        <div class="item-details">
                            <span><strong>$${fin.price}</strong></span>
                            ${fin.description ? `<span>${fin.description}</span>` : ''}
                        </div>
                    </div>
                    <div class="item-actions">
                        <button class="btn btn-sm btn-secondary" onclick="editFinishing('${id}')">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteFinishing('${id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }
        
        window.saveFinishing = async function(e) {
            e.preventDefault();
            updateSyncStatus('syncing', 'Syncing...');
            
            const finishing = {
                name: document.getElementById('finishingName').value,
                price: parseFloat(document.getElementById('finishingPrice').value),
                description: document.getElementById('finishingDescription').value,
                active: true
            };
            
            try {
                await push(ref(database, 'finishing'), finishing);
                showNotification('Finishing option added!');
                e.target.reset();
                loadFinishing();
                updateSyncStatus('synced', 'Synced');
            } catch (error) {
                showNotification('Error adding finishing option', 'error');
            }
        };
        
        window.deleteFinishing = async function(id) {
            if (!confirm('Delete this finishing option?')) return;
            
            try {
                await remove(ref(database, `finishing/${id}`));
                showNotification('Finishing option deleted');
                loadFinishing();
            } catch (error) {
                showNotification('Error deleting finishing option', 'error');
            }
        };
        
        // Shipping Functions
        async function loadShipping() {
            const shippingRef = ref(database, 'shipping');
            const snapshot = await get(shippingRef);
            const shipping = snapshot.val() || {};
            
            const list = document.getElementById('shippingList');
            if (Object.keys(shipping).length === 0) {
                list.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 40px;">No shipping options yet.</p>';
                return;
            }
            
            list.innerHTML = Object.entries(shipping).map(([id, ship]) => `
                <div class="item">
                    <div class="item-info">
                        <h3>${ship.name}</h3>
                        <div class="item-details">
                            <span><strong>$${ship.price}</strong></span>
                            <span>Availability: ${ship.availability}</span>
                            ${ship.description ? `<span>${ship.description}</span>` : ''}
                        </div>
                    </div>
                    <div class="item-actions">
                        <button class="btn btn-sm btn-secondary" onclick="editShipping('${id}')">Edit</button>
                        <button class="btn btn-sm btn-secondary" onclick="cloneShipping('${id}')">Clone</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteShipping('${id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }
        
        window.saveShipping = async function(e) {
            e.preventDefault();
            updateSyncStatus('syncing', 'Syncing...');
            
            const shipping = {
                name: document.getElementById('shippingName').value,
                price: parseFloat(document.getElementById('shippingPrice').value),
                availability: document.getElementById('shippingAvailability').value,
                description: document.getElementById('shippingDescription').value,
                active: true
            };
            
            try {
                await push(ref(database, 'shipping'), shipping);
                showNotification('Shipping option added!');
                e.target.reset();
                loadShipping();
                updateSyncStatus('synced', 'Synced');
            } catch (error) {
                showNotification('Error adding shipping option', 'error');
            }
        };
        
        window.deleteShipping = async function(id) {
            if (!confirm('Delete this shipping option?')) return;
            
            try {
                await remove(ref(database, `shipping/${id}`));
                showNotification('Shipping option deleted');
                loadShipping();
            } catch (error) {
                showNotification('Error deleting shipping option', 'error');
            }
        };
        
        window.cloneShipping = async function(id) {
            const snapshot = await get(ref(database, `shipping/${id}`));
            const shipping = snapshot.val();
            shipping.name += ' (Copy)';
            
            try {
                await push(ref(database, 'shipping'), shipping);
                showNotification('Shipping option cloned!');
                loadShipping();
            } catch (error) {
                showNotification('Error cloning shipping option', 'error');
            }
        };
        
        // Settings Functions
        async function loadSettings() {
            const settingsRef = ref(database, 'settings');
            const snapshot = await get(settingsRef);
            const settings = snapshot.val() || {};
            
            document.getElementById('settingsBusinessName').value = settings.businessName || 'TC SignLab';
            document.getElementById('settingsBusinessEmail').value = settings.businessEmail || 'tcsignlab@gmail.com';
            document.getElementById('settingsBusinessPhone').value = settings.businessPhone || '(866) 555-SIGN';
            document.getElementById('settingsFreeShipping').value = settings.freeShippingThreshold || 150;
            document.getElementById('settingsFacebook').value = settings.facebook || '';
            document.getElementById('settingsInstagram').value = settings.instagram || '';
        }
        
        window.saveSettings = async function(e) {
            e.preventDefault();
            updateSyncStatus('syncing', 'Syncing...');
            
            const settings = {
                businessName: document.getElementById('settingsBusinessName').value,
                businessEmail: document.getElementById('settingsBusinessEmail').value,
                businessPhone: document.getElementById('settingsBusinessPhone').value,
                freeShippingThreshold: parseFloat(document.getElementById('settingsFreeShipping').value),
                facebook: document.getElementById('settingsFacebook').value,
                instagram: document.getElementById('settingsInstagram').value
            };
            
            try {
                await set(ref(database, 'settings'), settings);
                showNotification('Settings saved!');
                updateSyncStatus('synced', 'Synced');
            } catch (error) {
                showNotification('Error saving settings', 'error');
            }
        };
        
        // Data Management
        window.exportData = async function() {
            updateSyncStatus('syncing', 'Exporting...');
            
            const data = {};
            const sections = ['products', 'categories', 'materials', 'sizes', 'finishing', 'shipping', 'settings'];
            
            for (const section of sections) {
                const snapshot = await get(ref(database, section));
                data[section] = snapshot.val();
            }
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tcsignlab-data-${Date.now()}.json`;
            a.click();
            
            showNotification('Data exported!');
            updateSyncStatus('synced', 'Synced');
        };
        
        window.importData = async function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (!confirm('This will replace ALL current data. Continue?')) return;
                    
                    updateSyncStatus('syncing', 'Importing...');
                    
                    for (const [section, content] of Object.entries(data)) {
                        if (content) {
                            await set(ref(database, section), content);
                        }
                    }
                    
                    showNotification('Data imported successfully!');
                    location.reload();
                } catch (error) {
                    showNotification('Error importing data', 'error');
                }
            };
            reader.readAsText(file);
        };
        
        window.resetData = async function() {
            if (!confirm('Reset ALL data to defaults? This cannot be undone!')) return;
            if (!confirm('Are you ABSOLUTELY sure? All products, categories, and settings will be lost!')) return;
            
            // Would implement default data reset here
            showNotification('Reset functionality - implement default data');
        };
        
        // System Status Check
        async function checkSystemStatus() {
            // Check Square
            try {
                const response = await fetch('/.netlify/functions/process-payment', {
                    method: 'OPTIONS'
                });
                
                if (response.ok) {
                    document.getElementById('squareStatus').innerHTML = `
                        <span class="status-dot active"></span>
                        <span>Active</span>
                    `;
                }
            } catch (error) {
                document.getElementById('squareStatus').innerHTML = `
                    <span class="status-dot inactive"></span>
                    <span>Not Connected</span>
                `;
            }
            
            // Check Netlify Functions
            try {
                const response = await fetch('/.netlify/functions/process-payment');
                document.getElementById('netlifyStatus').innerHTML = `
                    <span class="status-dot active"></span>
                    <span>Active</span>
                `;
            } catch (error) {
                document.getElementById('netlifyStatus').innerHTML = `
                    <span class="status-dot inactive"></span>
                    <span>Not Connected</span>
                `;
            }
        }
    </script>
</body>
</html>