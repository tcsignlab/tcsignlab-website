<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>TC SignLab Admin - DEBUG</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; }
        .debug { background: #fff3cd; padding: 15px; margin-bottom: 20px; border-radius: 5px; border: 2px solid #ffc107; }
        .header { background: #1D3557; color: white; padding: 20px; margin-bottom: 20px; border-radius: 8px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .tabs { background: white; padding: 15px; margin-bottom: 20px; border-radius: 8px; }
        .tab { padding: 10px 20px; background: #eee; border: none; margin-right: 10px; cursor: pointer; border-radius: 5px; font-weight: bold; }
        .tab.active { background: #0066cc; color: white; }
        .tab-content { display: none; background: white; padding: 20px; border-radius: 8px; }
        .tab-content.active { display: block; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin: 5px; }
        .btn-primary { background: #0066cc; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        input, select, textarea { width: 100%; padding: 8px; margin: 5px 0 15px 0; border: 1px solid #ddd; border-radius: 4px; }
        label { font-weight: bold; display: block; margin-top: 10px; }
        .item { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 5px; border: 2px solid #dee2e6; }
        .alert { padding: 15px; margin: 15px 0; border-radius: 5px; }
        .alert-success { background: #d4edda; color: #155724; }
        .alert-error { background: #f8d7da; color: #721c24; }
        .finish-item { background: white; padding: 10px; margin: 5px 0; border: 2px solid #0066cc; border-radius: 5px; }
        #productFormContainer { display: none; margin-top: 20px; background: #f8f9fa; padding: 20px; border-radius: 8px; }
    </style>
</head>
<body>
    <div class="debug">
        <h3>üîç DEBUG MODE - No Password Required</h3>
        <p id="connectionStatus">Connecting to Firebase...</p>
        <p id="dataStatus">Loading data...</p>
    </div>

    <div class="header">
        <h1>TC SignLab Admin Panel (Debug Mode)</h1>
    </div>

    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="switchTab('products')">Products (<span id="productCount">0</span>)</button>
            <button class="tab" onclick="switchTab('categories')">Categories (<span id="categoryCount">0</span>)</button>
            <button class="tab" onclick="switchTab('finishing')">Finishing Options (<span id="finishingCount">0</span>)</button>
        </div>

        <!-- PRODUCTS TAB -->
        <div id="productsTab" class="tab-content active">
            <h2>Products Management</h2>
            <button class="btn btn-primary" onclick="showProductForm()">+ Add New Product</button>
            
            <div id="productAlert"></div>

            <div id="productFormContainer">
                <h3>Add/Edit Product</h3>
                <form id="productForm" onsubmit="return saveProduct(event)">
                    <label>Product Name *</label>
                    <input type="text" id="pName" required>

                    <label>Category *</label>
                    <select id="pCategory" required>
                        <option value="">-- Select Category --</option>
                    </select>

                    <label>Base Price ($/sq ft) *</label>
                    <input type="number" id="pPrice" step="0.01" required>

                    <label>Description</label>
                    <textarea id="pDesc" rows="3"></textarea>

                    <label>Max Width (inches)</label>
                    <input type="number" id="pWidth" value="200">

                    <label>Max Height (inches)</label>
                    <input type="number" id="pHeight" value="150">

                    <label>Image URL</label>
                    <input type="url" id="pImage">

                    <label>Status</label>
                    <select id="pActive">
                        <option value="true">Active</option>
                        <option value="false">Inactive</option>
                    </select>

                    <div style="background: #fff3cd; padding: 15px; margin: 20px 0; border-radius: 5px;">
                        <h4>Finishing Options * (Must add at least one)</h4>
                        
                        <label>Select Category</label>
                        <select id="fCat" onchange="loadFinishingOptions()">
                            <option value="">-- Select Finishing Category --</option>
                        </select>
                        
                        <label>Select Option</label>
                        <select id="fOpt" disabled>
                            <option value="">Choose category first</option>
                        </select>
                        
                        <button type="button" class="btn btn-success" onclick="addFinishing()">Add This Option</button>
                        
                        <div id="selectedFinishingList"></div>
                    </div>

                    <button type="submit" class="btn btn-primary">Save Product</button>
                    <button type="button" class="btn" onclick="cancelProduct()" style="background: #6c757d; color: white;">Cancel</button>
                </form>
            </div>

            <div id="productsList"></div>
        </div>

        <!-- CATEGORIES TAB -->
        <div id="categoriesTab" class="tab-content">
            <h2>Product Categories</h2>
            <div style="background: #f8f9fa; padding: 20px; margin-bottom: 20px; border-radius: 8px;">
                <input type="text" id="catName" placeholder="Category name" style="width: 300px; display: inline-block;">
                <input type="text" id="catDesc" placeholder="Description" style="width: 400px; display: inline-block; margin-left: 10px;">
                <button class="btn btn-primary" onclick="addCategory()">Add Category</button>
            </div>
            <div id="categoriesList"></div>
        </div>

        <!-- FINISHING OPTIONS TAB -->
        <div id="finishingTab" class="tab-content">
            <h2>Finishing Options Management</h2>
            <div style="background: #e7f3ff; padding: 20px; margin-bottom: 20px; border-radius: 8px;">
                <h3>Create New Finishing Category</h3>
                <input type="text" id="finishCatName" placeholder="Category name (e.g., Edges, Mounting)" style="width: 400px;">
                <button class="btn btn-success" onclick="createFinishCategory()">Create Category</button>
            </div>
            <div id="finishingList"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, push, set, update, remove, onValue, get } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        console.log('üöÄ Starting admin panel...');

        const app = initializeApp({
            apiKey: "AIzaSyAlrfBLg-yJtUzYYJKGfGICS_PQuGE8caY",
            authDomain: "tcsignlab-admin.firebaseapp.com",
            databaseURL: "https://tcsignlab-admin-default-rtdb.firebaseio.com",
            projectId: "tcsignlab-admin",
            storageBucket: "tcsignlab-admin.firebasestorage.app",
            messagingSenderId: "382892123645",
            appId: "1:382892123645:web:cf45e472749c66165d6594"
        });

        const db = getDatabase(app);
        console.log('‚úÖ Firebase initialized');
        document.getElementById('connectionStatus').innerHTML = '‚úÖ Connected to Firebase';

        window.categories = {};
        window.products = {};
        window.finishingCats = {};
        window.editingProductId = null;
        window.selectedFinishing = [];

        // Initialize default finishing categories
        setTimeout(async () => {
            try {
                const snap = await get(ref(db, 'finishingCategories'));
                if (!snap.exists()) {
                    console.log('Creating default finishing categories...');
                    await set(ref(db, 'finishingCategories'), {
                        edges: {
                            name: 'Edges',
                            options: {
                                opt1: { name: 'Hems & Grommets', price: 15, description: 'Hemmed edges with metal grommets' },
                                opt2: { name: 'Heat Sealed', price: 12, description: 'Clean sealed edges' },
                                opt3: { name: 'Raw Cut', price: 0, description: 'Unfinished edges' }
                            }
                        },
                        mounting: {
                            name: 'Mounting',
                            options: {
                                opt1: { name: 'Pole Pockets', price: 20, description: 'Top and bottom pockets' },
                                opt2: { name: 'Grommets Only', price: 8, description: 'Metal grommets' },
                                opt3: { name: 'No Hardware', price: 0, description: 'No mounting hardware' }
                            }
                        }
                    });
                    console.log('‚úÖ Default categories created');
                }
            } catch (err) {
                console.error('Error creating defaults:', err);
            }
        }, 1000);

        // Load categories
        onValue(ref(db, 'categories'), (snap) => {
            console.log('üì¶ Categories loaded:', snap.val());
            window.categories = snap.val() || {};
            document.getElementById('categoryCount').textContent = Object.keys(window.categories).length;
            updateCategoryDropdown();
            displayCategories();
            document.getElementById('dataStatus').innerHTML = `‚úÖ Loaded ${Object.keys(window.categories).length} categories`;
        });

        // Load products
        onValue(ref(db, 'products'), (snap) => {
            console.log('üì¶ Products loaded:', snap.val());
            window.products = snap.val() || {};
            document.getElementById('productCount').textContent = Object.keys(window.products).length;
            displayProducts();
        });

        // Load finishing categories
        onValue(ref(db, 'finishingCategories'), (snap) => {
            console.log('üì¶ Finishing categories loaded:', snap.val());
            window.finishingCats = snap.val() || {};
            document.getElementById('finishingCount').textContent = Object.keys(window.finishingCats).length;
            updateFinishingDropdown();
            displayFinishingCategories();
        });

        function updateCategoryDropdown() {
            const select = document.getElementById('pCategory');
            select.innerHTML = '<option value="">-- Select Category --</option>' +
                Object.entries(window.categories).map(([id, cat]) => 
                    `<option value="${id}">${cat.name}</option>`
                ).join('');
            console.log('Updated category dropdown with', Object.keys(window.categories).length, 'categories');
        }

        function updateFinishingDropdown() {
            const select = document.getElementById('fCat');
            select.innerHTML = '<option value="">-- Select Finishing Category --</option>' +
                Object.entries(window.finishingCats).map(([id, cat]) => 
                    `<option value="${id}">${cat.name}</option>`
                ).join('');
            console.log('Updated finishing dropdown with', Object.keys(window.finishingCats).length, 'categories');
        }

        window.switchTab = function(tab) {
            console.log('Switching to tab:', tab);
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');
        };

        window.showProductForm = function() {
            console.log('Showing product form');
            document.getElementById('productFormContainer').style.display = 'block';
            document.getElementById('productForm').reset();
            window.editingProductId = null;
            window.selectedFinishing = [];
            updateSelectedFinishingDisplay();
        };

        window.cancelProduct = function() {
            console.log('Cancelling product form');
            document.getElementById('productFormContainer').style.display = 'none';
            document.getElementById('productForm').reset();
            window.editingProductId = null;
            window.selectedFinishing = [];
        };

        window.loadFinishingOptions = function() {
            const catId = document.getElementById('fCat').value;
            const optSelect = document.getElementById('fOpt');
            
            console.log('Loading finishing options for category:', catId);
            
            if (!catId) {
                optSelect.disabled = true;
                optSelect.innerHTML = '<option value="">Choose category first</option>';
                return;
            }

            const cat = window.finishingCats[catId];
            if (!cat || !cat.options) {
                optSelect.disabled = true;
                optSelect.innerHTML = '<option value="">No options available</option>';
                console.log('No options found for category:', catId);
                return;
            }

            optSelect.disabled = false;
            optSelect.innerHTML = '<option value="">-- Select Option --</option>' +
                Object.entries(cat.options).map(([optId, opt]) => 
                    `<option value="${optId}">${opt.name} (+$${opt.price})</option>`
                ).join('');
            
            console.log('Loaded', Object.keys(cat.options).length, 'options');
        };

        window.addFinishing = function() {
            const catId = document.getElementById('fCat').value;
            const optId = document.getElementById('fOpt').value;

            console.log('Adding finishing - catId:', catId, 'optId:', optId);

            if (!catId || !optId) {
                alert('‚ö†Ô∏è Please select both category and option');
                return;
            }

            const cat = window.finishingCats[catId];
            const opt = cat.options[optId];

            // Check duplicate
            const exists = window.selectedFinishing.find(f => 
                f.categoryId === catId && f.optionId === optId
            );
            
            if (exists) {
                alert('‚ö†Ô∏è This option is already added');
                return;
            }

            window.selectedFinishing.push({
                categoryId: catId,
                optionId: optId,
                category: cat.name,
                name: opt.name,
                price: opt.price,
                description: opt.description
            });

            console.log('Added finishing option. Total:', window.selectedFinishing.length);
            updateSelectedFinishingDisplay();
            
            // Reset selectors
            document.getElementById('fCat').value = '';
            document.getElementById('fOpt').disabled = true;
            document.getElementById('fOpt').innerHTML = '<option value="">Choose category first</option>';
        };

        window.removeFinishing = function(index) {
            console.log('Removing finishing at index:', index);
            window.selectedFinishing.splice(index, 1);
            updateSelectedFinishingDisplay();
        };

        function updateSelectedFinishingDisplay() {
            const container = document.getElementById('selectedFinishingList');
            
            if (window.selectedFinishing.length === 0) {
                container.innerHTML = '<p style="color: #999; margin-top: 15px;">No finishing options selected yet</p>';
                return;
            }

            container.innerHTML = `
                <div style="background: #d4edda; padding: 10px; margin-top: 15px; border-radius: 5px;">
                    <strong style="color: #155724;">‚úì ${window.selectedFinishing.length} option(s) selected</strong>
                </div>
            ` + window.selectedFinishing.map((f, i) => `
                <div class="finish-item" style="margin-top: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${f.category}: ${f.name}</strong> <span style="color: #e63946; font-weight: bold;">(+$${f.price})</span>
                            <div style="color: #666; font-size: 0.9rem;">${f.description}</div>
                        </div>
                        <button type="button" onclick="removeFinishing(${i})" class="btn btn-danger" style="padding: 5px 15px;">Remove</button>
                    </div>
                </div>
            `).join('');
        }

        window.saveProduct = async function(e) {
            e.preventDefault();
            console.log('Saving product...');

            if (window.selectedFinishing.length === 0) {
                alert('‚ö†Ô∏è Please add at least one finishing option');
                return false;
            }

            const product = {
                name: document.getElementById('pName').value,
                category: document.getElementById('pCategory').value,
                basePrice: parseFloat(document.getElementById('pPrice').value),
                description: document.getElementById('pDesc').value,
                maxWidth: parseInt(document.getElementById('pWidth').value),
                maxHeight: parseInt(document.getElementById('pHeight').value),
                imageUrl: document.getElementById('pImage').value,
                active: document.getElementById('pActive').value === 'true',
                finishingOptions: window.selectedFinishing
            };

            console.log('Product data:', product);

            try {
                if (window.editingProductId) {
                    await update(ref(db, `products/${window.editingProductId}`), product);
                    alert('‚úÖ Product updated successfully!');
                } else {
                    await push(ref(db, 'products'), product);
                    alert('‚úÖ Product added successfully!');
                }
                cancelProduct();
            } catch (err) {
                console.error('Error saving product:', err);
                alert('‚ùå Error: ' + err.message);
            }

            return false;
        };

        function displayProducts() {
            const container = document.getElementById('productsList');
            const items = Object.entries(window.products).map(([id, p]) => ({ id, ...p }));
            
            if (items.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 40px; color: #999;">No products yet. Click "Add New Product" to create one.</p>';
                return;
            }

            container.innerHTML = '<h3 style="margin-top: 30px;">Products List:</h3>' + items.map(p => `
                <div class="item">
                    <h3>${p.name}</h3>
                    <p><strong>Price:</strong> $${p.basePrice}/sq ft | <strong>Size:</strong> ${p.maxWidth}"W x ${p.maxHeight}"H</p>
                    <p><strong>Category:</strong> ${window.categories[p.category]?.name || 'N/A'}</p>
                    <p>${p.description || ''}</p>
                    ${p.finishingOptions?.length ? `
                        <div style="background: white; padding: 10px; margin-top: 10px; border-radius: 5px;">
                            <strong>Finishing Options (${p.finishingOptions.length}):</strong>
                            <ul style="margin-top: 5px;">
                                ${p.finishingOptions.map(f => `<li>${f.category}: ${f.name} (+$${f.price})</li>`).join('')}
                            </ul>
                        </div>
                    ` : '<p style="color: red;">‚ö†Ô∏è No finishing options</p>'}
                    <button onclick="editProduct('${p.id}')" class="btn btn-primary">Edit</button>
                    <button onclick="deleteProduct('${p.id}')" class="btn btn-danger">Delete</button>
                </div>
            `).join('');
        }

        window.editProduct = async function(id) {
            console.log('Editing product:', id);
            const p = window.products[id];
            window.editingProductId = id;
            
            document.getElementById('productFormContainer').style.display = 'block';
            document.getElementById('pName').value = p.name;
            document.getElementById('pCategory').value = p.category;
            document.getElementById('pPrice').value = p.basePrice;
            document.getElementById('pDesc').value = p.description || '';
            document.getElementById('pWidth').value = p.maxWidth;
            document.getElementById('pHeight').value = p.maxHeight;
            document.getElementById('pImage').value = p.imageUrl || '';
            document.getElementById('pActive').value = p.active ? 'true' : 'false';
            
            window.selectedFinishing = p.finishingOptions || [];
            updateSelectedFinishingDisplay();
            
            window.scrollTo(0, 0);
        };

        window.deleteProduct = async function(id) {
            if (!confirm('Delete this product?')) return;
            console.log('Deleting product:', id);
            await remove(ref(db, `products/${id}`));
            alert('‚úÖ Product deleted');
        };

        function displayCategories() {
            const container = document.getElementById('categoriesList');
            const items = Object.entries(window.categories).map(([id, c]) => ({ id, ...c }));
            
            if (items.length === 0) {
                container.innerHTML = '<p style="color: #999;">No categories yet</p>';
                return;
            }

            container.innerHTML = items.map(c => `
                <div class="item">
                    <strong style="font-size: 1.2rem;">${c.name}</strong>
                    <span style="color: #666;"> - ${c.description || ''}</span>
                    <button onclick="deleteCategory('${c.id}')" class="btn btn-danger" style="float: right;">Delete</button>
                    <div style="clear: both;"></div>
                </div>
            `).join('');
        }

        window.addCategory = async function() {
            const name = document.getElementById('catName').value;
            const desc = document.getElementById('catDesc').value;
            
            if (!name) {
                alert('‚ö†Ô∏è Please enter category name');
                return;
            }

            console.log('Adding category:', name);
            await push(ref(db, 'categories'), { name, description: desc });
            document.getElementById('catName').value = '';
            document.getElementById('catDesc').value = '';
            alert('‚úÖ Category added!');
        };

        window.deleteCategory = async function(id) {
            if (!confirm('Delete this category?')) return;
            console.log('Deleting category:', id);
            await remove(ref(db, `categories/${id}`));
            alert('‚úÖ Category deleted');
        };

        function displayFinishingCategories() {
            const container = document.getElementById('finishingList');
            const items = Object.entries(window.finishingCats).map(([id, c]) => ({ id, ...c }));
            
            if (items.length === 0) {
                container.innerHTML = '<p style="color: #999;">Loading finishing categories...</p>';
                return;
            }

            container.innerHTML = items.map(cat => `
                <div class="item">
                    <h3>${cat.name}</h3>
                    <div style="background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 5px;">
                        <strong>Add Option to ${cat.name}:</strong>
                        <input type="text" id="optName_${cat.id}" placeholder="Option name" style="width: 250px; display: inline-block; margin-right: 10px;">
                        <input type="number" id="optPrice_${cat.id}" placeholder="Price" value="0" step="0.01" style="width: 100px; display: inline-block; margin-right: 10px;">
                        <input type="text" id="optDesc_${cat.id}" placeholder="Description" style="width: 300px; display: inline-block; margin-right: 10px;">
                        <button onclick="addOption('${cat.id}')" class="btn btn-success">Add Option</button>
                    </div>
                    <div style="margin-top: 15px;">
                        <strong>Options in ${cat.name}:</strong>
                        ${Object.entries(cat.options || {}).map(([optId, opt]) => `
                            <div style="background: white; padding: 10px; margin: 5px 0; border-left: 4px solid #0066cc; border-radius: 4px;">
                                <strong>${opt.name}</strong> - $${opt.price} - ${opt.description}
                                <button onclick="deleteOption('${cat.id}', '${optId}')" class="btn btn-danger" style="float: right; padding: 5px 15px;">Delete</button>
                                <div style="clear: both;"></div>
                            </div>
                        `).join('') || '<p style="color: #999; margin: 10px 0;">No options yet</p>'}
                    </div>
                    <button onclick="deleteFinishCategory('${cat.id}')" class="btn btn-danger" style="margin-top: 10px;">Delete Entire Category</button>
                </div>
            `).join('');
        }

        window.createFinishCategory = async function() {
            const name = document.getElementById('finishCatName').value;
            
            if (!name) {
                alert('‚ö†Ô∏è Please enter category name');
                return;
            }

            console.log('Creating finishing category:', name);
            await push(ref(db, 'finishingCategories'), { name, options: {} });
            document.getElementById('finishCatName').value = '';
            alert('‚úÖ Finishing category created!');
        };

        window.addOption = async function(catId) {
            const name = document.getElementById(`optName_${catId}`).value;
            const price = parseFloat(document.getElementById(`optPrice_${catId}`).value);
            const desc = document.getElementById(`optDesc_${catId}`).value;
            
            if (!name) {
                alert('‚ö†Ô∏è Please enter option name');
                return;
            }

            console.log('Adding option to', catId, ':', name);
            await push(ref(db, `finishingCategories/${catId}/options`), { name, price, description: desc });
            document.getElementById(`optName_${catId}`).value = '';
            document.getElementById(`optPrice_${catId}`).value = '0';
            document.getElementById(`optDesc_${catId}`).value = '';
            alert('‚úÖ Option added!');
        };

        window.deleteFinishCategory = async function(id) {
            if (!confirm('Delete this category and all its options?')) return;
            console.log('Deleting finish category:', id);
            await remove(ref(db, `finishingCategories/${id}`));
            alert('‚úÖ Category deleted');
        };

        window.deleteOption = async function(catId, optId) {
            if (!confirm('Delete this option?')) return;
            console.log('Deleting option:', catId, optId);
            await remove(ref(db, `finishingCategories/${catId}/options/${optId}`));
            alert('‚úÖ Option deleted');
        };

        console.log('‚úÖ Admin panel fully loaded and ready!');
    </script>
</body>
</html>
